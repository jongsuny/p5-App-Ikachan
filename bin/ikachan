#!/usr/bin/env perl
use strict;
use warnings;
use 5.008001;
use File::Spec;
use File::Basename;
use lib File::Spec->catdir(dirname(__FILE__), '..', 'lib');

use AnySan;
use AnySan::Provider::IRC;
use Getopt::Long ();
use Pod::Usage;
use Plack::Builder;
use Plack::Builder::Conditionals;
use Plack::Request;
use Plack::Response;
use Twiggy::Server;

my $parser = Getopt::Long::Parser->new(
    config => [ "no_ignore_case", "pass_through" ],
);

my %options;
my($http_host, $http_port, $irc_server, $irc_port, $irc_keyword, $irc_nickname, $irc_user, $no_post_with_join, $irc_post_interval, $irc_reconnect_interval) =
    ('127.0.0.1', 4979, undef, 6667, undef, 'ikachan', undef, 0, 2, 3);
my @reverse_proxy;
$parser->getoptions(
    'o|host=s'     => \$http_host,
    'p|port=i'     => \$http_port,
    'r|reverse-proxy=s' => \@reverse_proxy,
    'S|Server=s'   => \$irc_server,
    'P|Port=i'     => \$irc_port,
    'K|Keyword=s'  => \$irc_keyword,
    'N|Nickname=s' => \$irc_nickname,
    'U|User=s'     => \$irc_user,
    'i|interval=s' => \$irc_post_interval,
    'R|reconnect-interval=s' => \$irc_reconnect_interval,
    'j|no-post-with-join' => \$no_post_with_join,
    'h|help'       => \$options{help},
    'v|version'    => \$options{version},
);
pod2usage(1) if $options{help};
die "Missing mandatory parameter: irc_server" unless defined $irc_server;

warn 'connecting to ' . join ' ', ($irc_server, $irc_port, ($irc_keyword || ''), $irc_nickname);

$irc_post_interval ||= 2;

my $irc;
my $join_channels = {};
my $is_connect = 0;
my $create_session; $create_session = sub {
    irc $irc_server,
        key      => $irc_server,
        port     => $irc_port,
        password => $irc_keyword,
        nickname => $irc_nickname,
        user     => $irc_user,
        interval => $irc_post_interval,
        on_connect => sub {
            my ($con, $err) = @_;
            if (defined $err) {
                warn "connect error: $err\n";
                exit 1 unless $irc_reconnect_interval;
                sleep $irc_reconnect_interval;
                $con->disconnect('try reconnect');
            } else {
                warn 'connect';
                $is_connect      = 1;
            }
        },
        on_disconnect => sub {
            warn 'disconnect';
            # XXX: bad hack...
            undef $irc->{client};
            undef $irc->{SEND_TIMER};
            undef $irc;
            $is_connect = 0;
            $irc = $create_session->();
        },
        channels => {
            map { $_ => +{} } keys %{ $join_channels },
        };
};
$irc = $create_session->();

sub rendar {
    my($code, $msg) = @_;
    my $res = Plack::Response->new($code);
    $res->content_type('text/plain');
    $res->content_length(length $msg);
    $res->body($msg);
    $res->finalize;
}

sub join_channel {
    my ($channel, $key) = @_;
    $irc->join_channel($channel, $key);
    $join_channels->{$channel} = {
        join_at => time(),
    };
}

my $code = sub {
    my $req = Plack::Request->new(shift);
    my $method = $req->method;
    my $path   = $req->path;

    if ($method eq 'POST' && ! $is_connect) {
        my $html = q{<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>ikachan</title>
    <head>
    <body>
        can not connect to irc server
    </body>
</html>};
        my $res = Plack::Response->new(503);
        $res->content_type('text/html; charset=utf-8');
        $res->content_length(length $html);
        $res->body($html);
        return $res->finalize;
    }

    if ($method eq 'GET') {
        if ($path eq '/channel_list') {
            my $list = [ keys %{ $join_channels } ];
            return rendar(200, join("\n", @$list));
        } elsif ($path eq '/') {
            my $base = $req->base;
            my $logo = get_logo();
            my $html =<<HTML;
<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>ikachan</title>
    <head>
    <body>
        <h1>
            ikachan
            <img src="data:image/png;base64,${logo}" />
        </h1>

        <h2>join channel list</h2>
        <iframe src="/channel_list"></iframe>

        <h2>API usage</u2>

        <h3>channel join</h3>
        <section>
            <table border="1">
                <tr><td>method</td><td>POST</td></tr>
                <tr><td>url</td><td>${base}join</td></tr>
                <tr><td>form params</td><td>channel=#channel&channel_keyword=keyword</td></tr>
            </table>
            <h4>testing form</h4>
            <form action="/join" method="post">
                join channel: <input name="channel" /><br />
                channel keyword(option): <input name="channel_keyword" /><input type="submit" value="join" />
            </form>
        <section>

        <section>
            <h3>channel leave</h3>
            <table border="1">
                <tr><td>method</td><td>POST</td></tr>
                <tr><td>url</td><td>${base}leave</td></tr>
                <tr><td>form params</td><td>channel=#channel</td></tr>
            </table>
            <form action="/leave" method="post">
                leave channel: <input name="channel" /><input type="submit" value="leave" />
            </form>
        <section>

        <section>
            <h3>sent notice message to channel</h3>
            <table border="1">
                <tr><td>method</td><td>POST</td></tr>
                <tr><td>url</td><td>${base}notice</td></tr>
                <tr><td>form params</td><td>channel=#channel&message=your_message</td></tr>
            </table>
            <form action="/notice" method="post">
                channel: <input name="channel" /><br />
                message: <input name="message" /><input type="submit" value="post" />
            </form>
        </section>

        <section>
            <h3>sent privmsg message to channel</h3>
            <table border="1">
                <tr><td>method</td><td>POST</td></tr>
                <tr><td>url</td><td>${base}privmsg</td></tr>
                <tr><td>form params</td><td>channel=#channel&message=your_message</td></tr>
            </table>
            <form action="/privmsg" method="post">
                channel: <input name="channel" /><br />
                message: <input name="message" /><input type="submit" value="post" />
            </form>
        </section>
    </body>
</html>
HTML

            my $res = Plack::Response->new(200);
            $res->content_type('text/html; charset=utf-8');
            $res->content_length(length $html);
            $res->body($html);
            return $res->finalize;
        }
    } elsif ($method eq 'POST') {
        my $channel = $req->param('channel');

        if ($path eq '/join') {
            return rendar(403, "joinned channel: $channel") if $join_channels->{$channel};
            my $channel_keyword = $req->param('channel_keyword');
            join_channel($channel, $channel_keyword);
            return rendar(200, "join success channel: $channel");
        } elsif ($path eq '/leave' || $path eq '/part') {
            return rendar(404, "not joinned channel: $channel") unless $join_channels->{$channel};
            $irc->leave_channel($channel);
            delete $join_channels->{$channel};
            return rendar(200, "leave success channel: $channel");
        } elsif ($path eq '/notice') {
            if ($no_post_with_join) {
                return rendar(404, "not joinned channel: $channel") unless $join_channels->{$channel};
            } elsif (not $join_channels->{$channel}) {
                join_channel($channel);
            }
            my $message = $req->param('message');
            $irc->send_message( $message, channel => $channel );
            return rendar(200, "message sent channel: $channel $message");
        } elsif ($path eq '/privmsg') {
            if ($no_post_with_join) {
                return rendar(404, "not joinned channel: $channel") unless $join_channels->{$channel};
            } elsif (not $join_channels->{$channel}) {
                join_channel($channel);
            }
            my $message = $req->param('message');
            $irc->send_message( $message, channel => $channel, privmsg => 1 );
            return rendar(200, "message sent channel: $channel $message");
        }
    }

    return rendar(404, 'not found');
};
my $app = builder {
    if ( @reverse_proxy ) {
        enable match_if addr(\@reverse_proxy), 'Plack::Middleware::ReverseProxy';
    }
    enable 'Plack::Middleware::AccessLog', format => 'combined';
    $code;
};

warn "starting httpd: http://$http_host:$http_port/";
my $twiggy = Twiggy::Server->new(
    host => $http_host,
    port => $http_port,
);
$twiggy->register_service($app);

AnySan->run;

sub get_logo {
    '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';
}

__END__

=head1 NAME

ikachan - IRC message delivery by HTTP

=head1 SYNOPSIS

  # connect to chat.freenode.net
  ikachan -S chat.freenode.net

=head1 OPTIONS

=over 4

=item -o, --host

The interface a TCP based server daemon binds to. Defauts to undef,
which lets most server backends bind the any (*) interface. This
option doesn't mean anything if the server does not support TCP
socket.

=item -p, --port (default: 4979)

The port number a TCP based server daemon listens on. Defaults to
5000. This option doesn't mean anything if the server does not support
TCP socket.

=item -S, --Server

irc server address.

=item -P, --Port (default: 6667)

irc server port.

=item -K, --Keyword

irc server password

=item -N, --Nickname

irc nickname

=item -U, --User

irc user name

=item -r, --reverse-proxy

treat X-Forwarded-For as REMOTE_ADDR if REMOTE_ADDR match this argument.

see L<Plack::Middleware::ReverseProxy>.

=item -i, --interval

irc post interval. for Excess Flood

=item -R, --reconnect-interval

interval of reconnect to irc server.
exit application if interval == 0.

=item -j, --no-post-with-join

disable to irc message post with channel join

=back

=head1 AUTHOR

Kazuhiro Osawa E<lt>yappo {at} shibuya {dot} plE<gt>

=head1 SEE ALSO

L<AnySan::Provider::IRC>, L<Twiggy>

=head1 LICENSE

This library is free software; you can redistribute it and/or modify
it under the same terms as Perl itself.

=cut
